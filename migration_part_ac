  email text NOT NULL,
  phone text NOT NULL,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);

CREATE TABLE IF NOT EXISTS coaching_bookings (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid REFERENCES profiles(id) ON DELETE SET NULL,
  coaching_type text NOT NULL CHECK (coaching_type IN ('cv_review', 'interview_prep', 'career_orientation')),
  scheduled_date timestamptz NOT NULL,
  duration integer NOT NULL CHECK (duration IN (30, 60, 120)),
  status text NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'confirmed', 'completed', 'cancelled')),
  payment_method text NOT NULL CHECK (payment_method IN ('orange_money', 'lengopay', 'digitalpay', 'card')),
  amount integer NOT NULL CHECK (amount >= 0),
  full_name text NOT NULL,
  email text NOT NULL,
  phone text NOT NULL,
  notes text DEFAULT '',
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);

CREATE TABLE IF NOT EXISTS trainer_applications (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid REFERENCES profiles(id) ON DELETE SET NULL,
  full_name text NOT NULL,
  email text NOT NULL,
  phone text NOT NULL,
  linkedin_url text DEFAULT '',
  expertise_domain text NOT NULL,
  experience_years integer NOT NULL CHECK (experience_years >= 0),
  description text NOT NULL,
  cv_url text DEFAULT '',
  portfolio_url text DEFAULT '',
  proposed_formations text NOT NULL,
  availability text NOT NULL,
  motivation text NOT NULL,
  status text NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'reviewed', 'approved', 'rejected')),
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);

-- ============================================================================
-- 2.12 Chatbot System
-- ============================================================================

CREATE TABLE IF NOT EXISTS chatbot_settings (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  is_enabled boolean DEFAULT true,
  position text DEFAULT 'bottom-right' CHECK (position IN ('bottom-right', 'bottom-left')),
  welcome_message text DEFAULT 'Bonjour! Comment puis-je vous aider aujourd''hui?',
  idle_message text DEFAULT 'Besoin d''aide? Je suis lÃ  pour vous!',
  ia_service_code text DEFAULT 'site_chatbot',
  show_quick_actions boolean DEFAULT true,
  max_context_messages int DEFAULT 10 CHECK (max_context_messages >= 0 AND max_context_messages <= 50),
  proactive_mode boolean DEFAULT false,
  proactive_delay int DEFAULT 15000 CHECK (proactive_delay >= 5000 AND proactive_delay <= 60000),
  updated_at timestamptz DEFAULT now(),
  created_at timestamptz DEFAULT now()
);

CREATE TABLE IF NOT EXISTS chatbot_styles (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  name text NOT NULL UNIQUE,
  primary_color text DEFAULT '#3B82F6',
  secondary_color text DEFAULT '#1E40AF',
  background_color text DEFAULT '#FFFFFF',
  text_color text DEFAULT '#1F2937',
  bubble_color_user text DEFAULT '#3B82F6',
  bubble_color_bot text DEFAULT '#F3F4F6',
  border_radius int DEFAULT 12 CHECK (border_radius >= 0 AND border_radius <= 50),
  widget_size text DEFAULT 'medium' CHECK (widget_size IN ('small', 'medium', 'large')),
  icon_type text DEFAULT 'default' CHECK (icon_type IN ('default', 'custom')),
  icon_value text,
  enable_dark_mode boolean DEFAULT true,
  shadow_strength text DEFAULT 'soft' CHECK (shadow_strength IN ('none', 'soft', 'strong')),
  animation_type text DEFAULT 'slide' CHECK (animation_type IN ('fade', 'slide', 'scale')),
  is_default boolean DEFAULT false,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);

CREATE TABLE IF NOT EXISTS chatbot_knowledge_base (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  category text NOT NULL,
  question text NOT NULL,
  answer text NOT NULL,
  intent_name text,
  priority_level int DEFAULT 1 CHECK (priority_level >= 1 AND priority_level <= 10),
  tags text[] DEFAULT '{}',
  is_active boolean DEFAULT true,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);

CREATE TABLE IF NOT EXISTS chatbot_quick_actions (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  label text NOT NULL,
  description text,
  icon text DEFAULT 'MessageCircle',
  action_type text NOT NULL CHECK (action_type IN ('open_route', 'open_modal', 'run_service')),
  action_payload jsonb NOT NULL DEFAULT '{}',
  is_active boolean DEFAULT true,
  order_index int DEFAULT 0,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);

CREATE TABLE IF NOT EXISTS chatbot_logs (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid REFERENCES auth.users(id) ON DELETE CASCADE,
  message_user text NOT NULL,
  message_bot text NOT NULL,
  tokens_used int DEFAULT 0,
  response_time_ms int,
  intent_detected text,
  page_url text,
  session_id text,
  created_at timestamptz DEFAULT now()
);

-- ============================================================================
-- SECTION 3: CREATE INDEXES
-- ============================================================================

-- Notifications indexes
CREATE INDEX IF NOT EXISTS idx_notifications_user_unread ON notifications(user_id, read) WHERE read = false;

-- Workflow stages indexes
CREATE INDEX IF NOT EXISTS idx_workflow_stages_company ON workflow_stages(company_id);

-- Application notes and timeline indexes
CREATE INDEX IF NOT EXISTS idx_application_notes_application_id ON application_notes(application_id);
CREATE INDEX IF NOT EXISTS idx_application_notes_recruiter ON application_notes(recruiter_id);
CREATE INDEX IF NOT EXISTS idx_application_timeline_application_id ON application_timeline(application_id);
CREATE INDEX IF NOT EXISTS idx_application_timeline_user ON application_timeline(user_id);

-- Recruiter messages indexes
CREATE INDEX IF NOT EXISTS idx_recruiter_messages_application_id ON recruiter_messages(application_id);
CREATE INDEX IF NOT EXISTS idx_recruiter_messages_sender ON recruiter_messages(sender_id);
CREATE INDEX IF NOT EXISTS idx_recruiter_messages_recipient_id ON recruiter_messages(recipient_id);

-- Talent searches indexes
CREATE INDEX IF NOT EXISTS idx_talent_searches_recruiter ON talent_searches(recruiter_id, created_at);
CREATE INDEX IF NOT EXISTS idx_favorite_candidates_recruiter ON favorite_candidates(recruiter_id);
CREATE INDEX IF NOT EXISTS idx_favorite_candidates_candidate ON favorite_candidates(candidate_id);
CREATE INDEX IF NOT EXISTS idx_candidate_contacts_recruiter ON candidate_contacts(recruiter_id, created_at);
CREATE INDEX IF NOT EXISTS idx_candidate_contacts_candidate ON candidate_contacts(candidate_id, created_at);
CREATE INDEX IF NOT EXISTS idx_cv_downloads_recruiter ON cv_downloads(recruiter_id, downloaded_at);

-- Profile cart and purchases indexes
CREATE INDEX IF NOT EXISTS idx_profile_cart_user_id ON profile_cart(user_id) WHERE user_id IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_profile_purchases_payment_status ON profile_purchases(payment_status);

-- Job features indexes
CREATE INDEX IF NOT EXISTS idx_saved_jobs_job_id ON saved_jobs(job_id);
CREATE INDEX IF NOT EXISTS idx_job_views_job_id ON job_views(job_id);
CREATE INDEX IF NOT EXISTS idx_job_views_user ON job_views(user_id);

-- Newsletter indexes
CREATE INDEX IF NOT EXISTS idx_newsletter_email ON newsletter_subscribers(email);
CREATE INDEX IF NOT EXISTS idx_newsletter_active ON newsletter_subscribers(is_active);
CREATE INDEX IF NOT EXISTS idx_newsletter_domain ON newsletter_subscribers(domain);

-- CMS indexes
CREATE INDEX IF NOT EXISTS idx_cms_media_uploaded_by ON cms_media(uploaded_by);
CREATE INDEX IF NOT EXISTS idx_cms_navigation_page_id ON cms_navigation(page_id);
CREATE INDEX IF NOT EXISTS idx_cms_navigation_parent_id ON cms_navigation(parent_id);
CREATE INDEX IF NOT EXISTS idx_cms_pages_author_id ON cms_pages(author_id);
CREATE INDEX IF NOT EXISTS idx_site_settings_updated_by ON site_settings(updated_by);
CREATE INDEX IF NOT EXISTS idx_admin_logs_admin ON admin_activity_logs(admin_id, created_at DESC);

-- Premium services indexes
CREATE INDEX IF NOT EXISTS idx_user_premium_services_user_id ON user_premium_services(user_id);
CREATE INDEX IF NOT EXISTS idx_user_premium_services_service_id ON user_premium_services(service_id);
CREATE INDEX IF NOT EXISTS idx_user_premium_services_status ON user_premium_services(status);
CREATE INDEX IF NOT EXISTS idx_ai_cv_generations_user_id ON ai_cv_generations(user_id);
CREATE INDEX IF NOT EXISTS idx_ai_cover_letters_user_id ON ai_cover_letters(user_id);
CREATE INDEX IF NOT EXISTS idx_ai_career_plans_user_id ON ai_career_plans(user_id);
CREATE INDEX IF NOT EXISTS idx_ai_chat_history_user_id ON ai_chat_history(user_id);
CREATE INDEX IF NOT EXISTS idx_ai_chat_history_session_id ON ai_chat_history(session_id);

-- Gold profile indexes
CREATE INDEX IF NOT EXISTS idx_coaching_sessions_user_id ON coaching_sessions(user_id);
CREATE INDEX IF NOT EXISTS idx_coaching_sessions_coach_id ON coaching_sessions(coach_id);
CREATE INDEX IF NOT EXISTS idx_coaching_sessions_scheduled_at ON coaching_sessions(scheduled_at);
CREATE INDEX IF NOT EXISTS idx_video_cvs_user_id ON video_cvs(user_id);
CREATE INDEX IF NOT EXISTS idx_video_cvs_status ON video_cvs(status);
CREATE INDEX IF NOT EXISTS idx_video_cvs_is_featured ON video_cvs(is_featured);
CREATE INDEX IF NOT EXISTS idx_profile_visibility_stats_user_id ON profile_visibility_stats(user_id);
CREATE INDEX IF NOT EXISTS idx_profile_visibility_stats_date ON profile_visibility_stats(date);
CREATE INDEX IF NOT EXISTS idx_candidate_profiles_priority ON candidate_profiles(priority_ranking);

-- Trainer and formations indexes
CREATE INDEX IF NOT EXISTS idx_trainer_profiles_profile_id ON trainer_profiles(profile_id);
CREATE INDEX IF NOT EXISTS idx_trainer_profiles_user_id ON trainer_profiles(user_id);
CREATE INDEX IF NOT EXISTS idx_trainer_profiles_is_verified ON trainer_profiles(is_verified);
CREATE INDEX IF NOT EXISTS idx_formation_enrollments_user ON formation_enrollments(user_id);
CREATE INDEX IF NOT EXISTS idx_formation_enrollments_formation ON formation_enrollments(formation_id);
CREATE INDEX IF NOT EXISTS idx_formation_enrollments_status ON formation_enrollments(status);
CREATE INDEX IF NOT EXISTS idx_coaching_bookings_user ON coaching_bookings(user_id);
CREATE INDEX IF NOT EXISTS idx_coaching_bookings_date ON coaching_bookings(scheduled_date);
CREATE INDEX IF NOT EXISTS idx_coaching_bookings_status ON coaching_bookings(status);
CREATE INDEX IF NOT EXISTS idx_trainer_applications_user ON trainer_applications(user_id);
CREATE INDEX IF NOT EXISTS idx_trainer_applications_status ON trainer_applications(status);

-- Chatbot indexes
CREATE INDEX IF NOT EXISTS idx_kb_category ON chatbot_knowledge_base(category) WHERE is_active = true;
CREATE INDEX IF NOT EXISTS idx_kb_intent ON chatbot_knowledge_base(intent_name) WHERE is_active = true AND intent_name IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_kb_tags ON chatbot_knowledge_base USING gin(tags);
CREATE INDEX IF NOT EXISTS idx_quick_actions_order ON chatbot_quick_actions(order_index) WHERE is_active = true;
CREATE INDEX IF NOT EXISTS idx_chatbot_logs_user ON chatbot_logs(user_id, created_at DESC);
CREATE INDEX IF NOT EXISTS idx_chatbot_logs_session ON chatbot_logs(session_id, created_at);
CREATE INDEX IF NOT EXISTS idx_chatbot_logs_created ON chatbot_logs(created_at DESC);

-- ============================================================================
-- SECTION 4: ENABLE ROW LEVEL SECURITY
-- ============================================================================

ALTER TABLE notifications ENABLE ROW LEVEL SECURITY;
ALTER TABLE notification_preferences ENABLE ROW LEVEL SECURITY;
ALTER TABLE workflow_stages ENABLE ROW LEVEL SECURITY;
ALTER TABLE application_notes ENABLE ROW LEVEL SECURITY;
ALTER TABLE application_timeline ENABLE ROW LEVEL SECURITY;
ALTER TABLE recruiter_messages ENABLE ROW LEVEL SECURITY;
ALTER TABLE recruitment_analytics ENABLE ROW LEVEL SECURITY;
ALTER TABLE talent_searches ENABLE ROW LEVEL SECURITY;
ALTER TABLE favorite_candidates ENABLE ROW LEVEL SECURITY;
ALTER TABLE candidate_contacts ENABLE ROW LEVEL SECURITY;
ALTER TABLE profile_verifications ENABLE ROW LEVEL SECURITY;
ALTER TABLE cv_downloads ENABLE ROW LEVEL SECURITY;
ALTER TABLE profile_cart ENABLE ROW LEVEL SECURITY;
ALTER TABLE profile_purchases ENABLE ROW LEVEL SECURITY;
ALTER TABLE saved_jobs ENABLE ROW LEVEL SECURITY;
ALTER TABLE job_views ENABLE ROW LEVEL SECURITY;
ALTER TABLE newsletter_subscribers ENABLE ROW LEVEL SECURITY;
ALTER TABLE site_settings ENABLE ROW LEVEL SECURITY;
ALTER TABLE cms_pages ENABLE ROW LEVEL SECURITY;
ALTER TABLE cms_sections ENABLE ROW LEVEL SECURITY;
ALTER TABLE cms_media ENABLE ROW LEVEL SECURITY;
ALTER TABLE cms_navigation ENABLE ROW LEVEL SECURITY;
ALTER TABLE cms_translations ENABLE ROW LEVEL SECURITY;
ALTER TABLE admin_activity_logs ENABLE ROW LEVEL SECURITY;
ALTER TABLE premium_services ENABLE ROW LEVEL SECURITY;
ALTER TABLE user_premium_services ENABLE ROW LEVEL SECURITY;
ALTER TABLE ai_cv_generations ENABLE ROW LEVEL SECURITY;
ALTER TABLE ai_cover_letters ENABLE ROW LEVEL SECURITY;
ALTER TABLE ai_career_plans ENABLE ROW LEVEL SECURITY;
ALTER TABLE ai_chat_history ENABLE ROW LEVEL SECURITY;
ALTER TABLE coaching_sessions ENABLE ROW LEVEL SECURITY;
ALTER TABLE video_cvs ENABLE ROW LEVEL SECURITY;
ALTER TABLE profile_visibility_stats ENABLE ROW LEVEL SECURITY;
ALTER TABLE service_credit_costs ENABLE ROW LEVEL SECURITY;
ALTER TABLE credit_purchases ENABLE ROW LEVEL SECURITY;
ALTER TABLE trainer_profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE formation_enrollments ENABLE ROW LEVEL SECURITY;
ALTER TABLE coaching_bookings ENABLE ROW LEVEL SECURITY;
ALTER TABLE trainer_applications ENABLE ROW LEVEL SECURITY;
ALTER TABLE chatbot_settings ENABLE ROW LEVEL SECURITY;
ALTER TABLE chatbot_styles ENABLE ROW LEVEL SECURITY;
ALTER TABLE chatbot_knowledge_base ENABLE ROW LEVEL SECURITY;
ALTER TABLE chatbot_quick_actions ENABLE ROW LEVEL SECURITY;
ALTER TABLE chatbot_logs ENABLE ROW LEVEL SECURITY;

-- ============================================================================
-- SECTION 5: CREATE RLS POLICIES
-- ============================================================================

-- ============================================================================
-- 5.1 Notifications policies
-- ============================================================================
DROP POLICY IF EXISTS "Users can view own notifications" ON notifications;
CREATE POLICY "Users can view own notifications"
  ON notifications FOR SELECT
  TO authenticated
  USING (user_id = (SELECT auth.uid()));

DROP POLICY IF EXISTS "Users can update own notifications" ON notifications;
CREATE POLICY "Users can update own notifications"
  ON notifications FOR UPDATE
  TO authenticated
  USING (user_id = (SELECT auth.uid()))
  WITH CHECK (user_id = (SELECT auth.uid()));

DROP POLICY IF EXISTS "Users can delete own notifications" ON notifications;
CREATE POLICY "Users can delete own notifications"
  ON notifications FOR DELETE
  TO authenticated
  USING (user_id = (SELECT auth.uid()));

DROP POLICY IF EXISTS "System can insert notifications" ON notifications;
CREATE POLICY "System can insert notifications"
  ON notifications FOR INSERT
  TO authenticated
  WITH CHECK (true);

-- Notification preferences policies
DROP POLICY IF EXISTS "Users can view own preferences" ON notification_preferences;
CREATE POLICY "Users can view own preferences"
  ON notification_preferences FOR SELECT
  TO authenticated
  USING (user_id = (SELECT auth.uid()));

DROP POLICY IF EXISTS "Users can insert own preferences" ON notification_preferences;
CREATE POLICY "Users can insert own preferences"
  ON notification_preferences FOR INSERT
  TO authenticated
  WITH CHECK (user_id = (SELECT auth.uid()));

DROP POLICY IF EXISTS "Users can update own preferences" ON notification_preferences;
CREATE POLICY "Users can update own preferences"
  ON notification_preferences FOR UPDATE
  TO authenticated
  USING (user_id = (SELECT auth.uid()))
  WITH CHECK (user_id = (SELECT auth.uid()));

-- ============================================================================
-- 5.2 Workflow stages policies
-- ============================================================================
DROP POLICY IF EXISTS "Companies can manage their workflow stages" ON workflow_stages;
CREATE POLICY "Companies can manage their workflow stages"
  ON workflow_stages
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM companies
      WHERE companies.id = company_id
      AND companies.profile_id = (SELECT auth.uid())
    )
  );

-- ============================================================================
-- 5.3 Application notes policies
-- ============================================================================
DROP POLICY IF EXISTS "Recruiters can view notes for their company applications" ON application_notes;
CREATE POLICY "Recruiters can view notes for their company applications"
  ON application_notes FOR SELECT
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM applications a
      JOIN jobs j ON a.job_id = j.id
      JOIN companies c ON j.company_id = c.id
      WHERE a.id = application_id
      AND c.profile_id = (SELECT auth.uid())
    )
  );

DROP POLICY IF EXISTS "Recruiters can create notes" ON application_notes;
CREATE POLICY "Recruiters can create notes"
  ON application_notes FOR INSERT
  TO authenticated
  WITH CHECK (
    recruiter_id = (SELECT auth.uid()) AND
    EXISTS (
      SELECT 1 FROM applications a
      JOIN jobs j ON a.job_id = j.id
      JOIN companies c ON j.company_id = c.id
      WHERE a.id = application_id
      AND c.profile_id = (SELECT auth.uid())
    )
  );

-- ============================================================================
-- 5.4 Application timeline policies
-- ============================================================================
DROP POLICY IF EXISTS "Recruiters and candidates can view timeline" ON application_timeline;
CREATE POLICY "Recruiters and candidates can view timeline"
  ON application_timeline FOR SELECT
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM applications a
      WHERE a.id = application_id
      AND (
        a.candidate_id = (SELECT auth.uid()) OR
        EXISTS (
          SELECT 1 FROM jobs j
          JOIN companies c ON j.company_id = c.id
          WHERE j.id = a.job_id
          AND c.profile_id = (SELECT auth.uid())
        )
      )
    )
  );

DROP POLICY IF EXISTS "System can insert timeline events" ON application_timeline;
CREATE POLICY "System can insert timeline events"
  ON application_timeline FOR INSERT
  TO authenticated
  WITH CHECK (true);

-- ============================================================================
-- 5.5 Recruiter messages policies
-- ============================================================================
DROP POLICY IF EXISTS "Users can view their messages" ON recruiter_messages;
CREATE POLICY "Users can view their messages"
  ON recruiter_messages FOR SELECT
  TO authenticated
